{% extends 'base.html' %}

{% block title %}æ¯”èµ›ç­¾åˆ°{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}?v=final_fix">
<style>
    .player-block-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    .player-block-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }
    .player-block-desc {
        font-size: 16px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}

<div class="m3-shell">

    <!-- é¡¶éƒ¨æ ‡é¢˜æ ï¼šä½¿ç”¨ m3-app-barï¼Œå¸¦åœ†è§’ -->
    <div class="m3-app-bar mb-3 app-bar">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex flex-column">
                <div class="m3-app-bar-event">
                    ğŸ† æ¯”èµ›ç­¾åˆ°
                </div>
                <span class="m3-app-bar-title-sub">
                    Maimai DX Tournament Â· Player Portal
                </span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="chip-current-event d-none d-md-inline-flex">
                    <span>å½“å‰èµ›äº‹ï¼š</span>
                    <strong>maimai DX æ¯”èµ›</strong>
                </span>
                {% if player %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm bg-white bg-opacity-20">
                    <i class="bi bi-box-arrow-right"></i> é€€å‡ºç™»å½•
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="main-shell">
        <div class="main-layout">

            {% if player %}
            <div class="page-grid">

                <!-- å·¦ä¾§ï¼šé€‰æ‰‹çŠ¶æ€ + æŠ½é€‰çŠ¶æ€ -->
                <section class="card-surface">
                    <div class="card-surface-inner">

                        <div class="card-surface-header">
                            <div>
                                <div class="card-surface-title">é€‰æ‰‹ä¿¡æ¯ä¸æŠ½é€‰çŠ¶æ€</div>
                                <div class="card-surface-subtitle">æŸ¥çœ‹æ‚¨çš„ç­¾åˆ°çŠ¶æ€ã€æ¯”èµ›åºå·ä¸æ›²ç›®æŠ½é€‰ä¿¡æ¯ã€‚</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="player-badge d-flex align-items-center p-3 bg-light rounded shadow-sm">
                                {% if player.avatar_filename %}
                                <img src="{{ url_for('static', filename='avatars/' + player.avatar_filename) }}" 
                                     alt="Avatar" class="rounded-circle me-3 border" width="60" height="60" style="object-fit: cover;">
                                {% else %}
                                <div class="rounded-circle me-3 bg-primary bg-opacity-25 d-flex align-items-center justify-content-center text-primary fw-bold" 
                                     style="width: 60px; height: 60px; font-size: 24px;">
                                    {{ player.name[0] | upper }}
                                </div>
                                {% endif %}
                                <div>
                                    <div class="fs-5">ğŸ‘‹ ä½ å¥½ï¼Œ<strong>{{ player.name }}</strong></div>
                                    <div class="player-rating text-muted">
                                        Ratingï¼š<strong>{{ player.rating }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# æ›²ç›®æŠ½é€‰å±•ç¤ºï¼šåªæ˜¾ç¤ºæœ¬é€‰æ‰‹ç»„åˆ«çš„æŠ½é€‰ #}
                        <div id="song-draw-player-panel" class="mb-3 d-none">
                            <div class="card border-0">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">

                                        <!-- å·¦ä¾§æ–‡å­—éƒ¨åˆ† -->
                                        <div class="flex-grow-1 text-start">
                                            <div class="small text-muted" id="song-draw-player-status">
                                                å½“å‰æœªåœ¨æŠ½é€‰ã€‚
                                            </div>
                                            <div class="fw-bold mt-1" id="song-draw-player-phase"></div>
                                            <div class="small text-muted" id="song-draw-player-tip"></div>
                                        </div>

                                        <!-- å³ä¾§æ›²ç»˜ + æ›²åï¼ˆåŒæ§½ä½ï¼‰ -->
                                        <div class="ms-3 d-flex flex-column gap-2 text-center">

                                            <!-- ç¬¬ 1 é¦–æ›²ç›® -->
                                            <div class="song-slot">
                                                <img id="song-draw-player-image"
                                                    class="img-fluid rounded shadow-sm d-none" style="max-height:120px;"
                                                    alt="song image">
                                                <div id="song-draw-player-name" class="mt-1 fw-semibold"></div>
                                            </div>

                                            <!-- ç¬¬ 2 é¦–æ›²ç›® -->
                                            <div class="song-slot d-none" id="song-draw-player-slot-2">
                                                <img id="song-draw-player-image-2"
                                                    class="img-fluid rounded shadow-sm d-none" style="max-height:120px;"
                                                    alt="song image 2">
                                                <div id="song-draw-player-name-2" class="mt-1 fw-semibold"></div>
                                            </div>

                                        </div> <!-- /å³ä¾§æ§½ä½ -->

                                    </div> <!-- /d-flex align-items-center -->
                                </div> <!-- /card-body -->
                            </div> <!-- /card -->
                        </div> <!-- /song-draw-player-panel -->

                        <!-- æ¯”èµ›å¯¹æˆ˜ä¿¡æ¯å¡ç‰‡ (1v1 / Peak) -->
                        <div id="match-info-card" class="card border-0 mb-3 shadow-sm d-none"
                            style="background-color: #f8f9fa;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-controller"></i> å½“å‰å¯¹æˆ˜</h6>
                                    <span class="badge bg-primary bg-opacity-10 text-primary"
                                        id="match-phase-badge"></span>
                                </div>

                                <div class="row align-items-center mb-3">
                                    <div class="col-5 text-center">
                                        <div class="fw-bold text-primary mb-1">YOU</div>
                                        <div class="fs-5 fw-bold">{{ player.name }}</div>
                                    </div>
                                    <div class="col-2 text-center">
                                        <div class="fw-bold text-muted fst-italic">VS</div>
                                    </div>
                                    <div class="col-5 text-center">
                                        <div class="fw-bold text-danger mb-1">OPPONENT</div>
                                        <div class="fs-5 fw-bold" id="match-opponent-name">--</div>
                                        <div class="small text-muted" id="match-opponent-info"></div>
                                        <div class="small text-danger d-none" id="match-opponent-forfeited">(å·²å¼ƒæƒ)</div>
                                    </div>
                                </div>

                                <!-- å·…å³°ç»„æ“ä½œé¢æ¿ -->
                                <div id="peak-control-panel" class="d-none border-top pt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0 small text-muted text-uppercase">Peak BO1 Tactics</h6>
                                    </div>

                                    <!-- æˆ‘æ–¹é€‰æ›² -->
                                    <div
                                        class="mb-2 p-2 bg-white rounded shadow-sm d-flex align-items-center justify-content-between border">
                                        <div>
                                            <span class="badge bg-primary me-2">æˆ‘æ–¹è‡ªé€‰</span>
                                            <span id="my-peak-song-text" class="fw-medium">æœªæäº¤</span>
                                        </div>
                                        <button class="btn btn-sm btn-primary py-0" id="btn-open-peak-modal">æäº¤</button>
                                    </div>

                                    <!-- å¯¹æ–¹é€‰æ›² -->
                                    <div
                                        class="mb-0 p-2 bg-white rounded shadow-sm d-flex align-items-center justify-content-between border">
                                        <div>
                                            <span class="badge bg-danger me-2">å¯¹æ–¹è‡ªé€‰</span>
                                            <span id="op-peak-song-text" class="fw-medium text-muted">ç­‰å¾…å¯¹æ–¹...</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-danger py-0 d-none"
                                                id="btn-ban-peak">BAN</button>
                                            <span class="badge bg-danger d-none" id="badge-peak-banned">å·² BAN</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# ä¸‹é¢æ˜¯å„ç§çŠ¶æ€åˆ†æ”¯ï¼Œå’Œä½ åŸæ¥å®Œå…¨ä¸€è‡´ #}
                        {% if player.match_number is none and player.score_round1 is none and player.promotion_status in
                        ['none', 'eliminated'] %}
                        <div class="mt-2">
                            <h5 class="mb-1">âœ… ç­¾åˆ°æˆåŠŸ</h5>
                            <p class="text-muted mt-2">è¯·è€å¿ƒç­‰å¾…ç®¡ç†å‘˜åˆ†é…ç»„åˆ«åºå·ã€‚</p>
                            <a href="/" class="btn btn-outline-primary btn-sm mt-1">åˆ·æ–°é¡µé¢</a>
                        </div>
                        {% set group_name = 'èŒæ–°ç»„' if player.group == 'beginner' else 'è¿›é˜¶ç»„' %}
                        <div class="status-badge promoted">
                            <h5 class="mb-0">â­ æ‚¨å·²è¿›å…¥å¤æ´»èµ›ï¼ï¼ˆ{{ group_name }}ï¼‰</h5>
                            <p class="mt-2 mb-1">
                                æ‚¨åœ¨ç¬¬ä¸€è½®çš„ç»„å†…æ’åä¸º 16â€“19 åï¼Œè·å¾—å¤æ´»èµ›èµ„æ ¼ã€‚
                            </p>
                            <p class="small mb-2">ç¬¬ä¸€è½®æˆç»©ï¼š{{ player.score_round1 }}</p>
                            <p class="small mb-0">è¯·ç­‰å¾…å«å·ä¸Šæœºè¿›è¡Œå¤æ´»èµ›ã€‚</p>
                        </div>
                        {% include 'machine_control.html' %}

                        {% elif player.promotion_status == 'revival' and player.score_revival is not none %}
                        <div class="alert alert-info">
                            <h5 class="mb-0">âŒ› æ‚¨å·²å®Œæˆå¤æ´»èµ›</h5>
                            <p class="mt-2 mb-1">è¯·ç­‰å¾…å¤æ´»èµ›ç»“æœå…¬å¸ƒã€‚</p>
                            <div class="final-score">
                                ç¬¬ä¸€è½®æˆç»©: {{ player.score_round1 }} <br>
                                å¤æ´»èµ›æˆç»©: {{ player.score_revival }}
                            </div>
                        </div>

                        {% elif player.score_round1 is none and player.promotion_status in ['none', 'eliminated'] %}
                        {% set group_name = 'èŒæ–°ç»„' if player.group == 'beginner' else 'è¿›é˜¶ç»„' %}
                        {% set group_color_class = 'group-green' if player.group == 'beginner' else 'group-red' %}
                        <div class="mt-3">
                            <p class="text-muted">æ‚¨çš„æ¯”èµ›åºå·æ˜¯ï¼š</p>
                            <div class="number-display" id="match-number-display">
                                <span class="{{ group_color_class }}">{{ group_name }}</span>
                                <span class="number-blue" id="player-match-num">{{ player.match_number }}</span>
                                <span class="{{ group_color_class }}">å·</span>
                            </div>
                            {% include 'machine_control.html' %}
                        </div>

                        {% elif player.promotion_status == 'top16' %}
                        {% set group_name = 'èŒæ–°ç»„' if player.group == 'beginner' else 'è¿›é˜¶ç»„' %}
                        <div class="celebration">
                            <div class="rocket"></div>
                            <div class="spark spark-1"></div>
                            <div class="spark spark-2"></div>
                            <div class="spark spark-3"></div>
                            <div class="spark spark-4"></div>
                            <div class="spark spark-5"></div>
                            <div class="spark spark-6"></div>
                            <div class="spark spark-7"></div>
                            <div class="spark spark-8"></div>
                        </div>
                        <div class="status-badge promoted">
                            <h5 class="mb-0">ğŸŒŸ æ­å–œæ‚¨æ™‹çº§ 16 å¼ºï¼ï¼ˆ{{ group_name }}ï¼‰</h5>
                            <p class="mt-2 mb-0">
                                æ‚¨å·²è¿›å…¥æœ¬ç»„ 16 å¼ºï¼Œè¯·ç­‰å¾… 16 è¿› 8 æ¯”èµ›å®‰æ’ã€‚
                            </p>
                            <p class="small mt-2 mb-0">
                                ç¬¬ä¸€è½®æˆç»©ï¼š{{ player.score_round1 }}
                                {% if player.score_revival is not none %}
                                ï¼Œå¤æ´»èµ›æˆç»©ï¼š{{ player.score_revival }}
                                {% endif %}
                            </p>
                        </div>
                        {% include 'machine_control.html' %}

                        {% elif player.promotion_status == 'top16_out' %}
                        <div class="alert alert-danger">
                            <h5 class="mb-1">ğŸ’” å¾ˆé—æ†¾ï¼Œæ‚¨åœ¨ 16 è¿› 8 æ¯”èµ›ä¸­è¢«æ·˜æ±°ã€‚</h5>
                            <p class="mb-1">ä¸è¿‡åˆ«ç°å¿ƒï¼Œæ‚¨ä»ç„¶å¯ä»¥é¢†å– 16 å¼ºå¥–å“å¹¶ç»§ç»­è§‚èµ›ï¼</p>
                            <p class="small mb-0">
                                ç¬¬ä¸€è½®æˆç»©ï¼š{{ player.score_round1 }}
                                {% if player.score_revival is not none %}
                                ï¼Œå¤æ´»èµ›æˆç»©ï¼š{{ player.score_revival }}
                                {% endif %}
                            </p>
                        </div>

                        {% elif player.promotion_status == 'top8' %}
                        {% set group_name = 'èŒæ–°ç»„' if player.group == 'beginner' else 'è¿›é˜¶ç»„' %}
                        <div class="celebration">
                            <div class="rocket"></div>
                            <div class="spark spark-1"></div>
                            <div class="spark spark-2"></div>
                            <div class="spark spark-3"></div>
                            <div class="spark spark-4"></div>
                            <div class="spark spark-5"></div>
                            <div class="spark spark-6"></div>
                            <div class="spark spark-7"></div>
                            <div class="spark spark-8"></div>
                        </div>
                        <div class="status-badge promoted">
                            <h5 class="mb-0">ğŸ… æ­å–œæ‚¨æ™‹çº§ 8 å¼ºï¼ï¼ˆ{{ group_name }}ï¼‰</h5>
                            <p class="mt-2 mb-0">
                                æ‚¨å·²è¿›å…¥æœ¬ç»„ 8 å¼ºï¼Œè¯·ç­‰å¾… 8 è¿› 4 æ¯”èµ›å®‰æ’ã€‚
                            </p>
                        </div>
                        {% include 'machine_control.html' %}

                        {% elif player.promotion_status == 'top8_out' %}
                        <div class="alert alert-danger">
                            <h5 class="mb-1">ğŸ’” å¾ˆé—æ†¾ï¼Œæ‚¨åœ¨ 8 è¿› 4 æ¯”èµ›ä¸­è¢«æ·˜æ±°ã€‚</h5>
                            <p class="mb-1">ä¸è¿‡åˆ«ç°å¿ƒï¼Œæ‚¨ä»ç„¶å¯ä»¥é¢†å– 8 å¼ºå¥–å“å¹¶ç»§ç»­è§‚èµ›ï¼</p>
                            <p class="small mb-0">
                                ç¬¬ä¸€è½®æˆç»©ï¼š{{ player.score_round1 }}
                                {% if player.score_revival is not none %}
                                ï¼Œå¤æ´»èµ›æˆç»©ï¼š{{ player.score_revival }}
                                {% endif %}
                            </p>
                        </div>

                        {% elif player.promotion_status in ['top4', 'top4_peak', 'final'] %}
                        {% set group_name = 'èŒæ–°ç»„' if player.group == 'beginner' else ('å·…å³°ç»„' if player.group == 'peak' else 'è¿›é˜¶ç»„') %}
                        {% set phase_name = 'å†³èµ›' if player.promotion_status == 'final' else '4 å¼º' %}
                        <div class="celebration">
                            <div class="rocket"></div>
                            <div class="spark spark-1"></div>
                            <div class="spark spark-2"></div>
                            <div class="spark spark-3"></div>
                            <div class="spark spark-4"></div>
                            <div class="spark spark-5"></div>
                            <div class="spark spark-6"></div>
                            <div class="spark spark-7"></div>
                            <div class="spark spark-8"></div>
                        </div>
                        <div class="status-badge promoted">
                            <h5 class="mb-0">ğŸ† æ­å–œæ‚¨æ™‹çº§æœ¬ç»„ {{ phase_name }}ï¼ï¼ˆ{{ group_name }}ï¼‰</h5>
                            <p class="mt-2 mb-0">
                                æ‚¨å·²æ™‹çº§æœ¬ç»„ {{ phase_name }}ï¼Œè¯·ç­‰å¾…æ¯”èµ›å¼€å§‹ã€‚å±Šæ—¶ä»åªéœ€ä¸Šæœº / ä¸‹æœºï¼Œæ— éœ€æäº¤æˆç»©ã€‚
                            </p>
                        </div>
                        {% include 'machine_control.html' %}

                        {% elif player.promotion_status in ['third', 'fourth', 'runner_up', 'champion'] %}
                        {% if player.promotion_status == 'third' %}
                        {% set rank_name = 'å­£å†›' %}
                        {% elif player.promotion_status == 'fourth' %}
                        {% set rank_name = 'æ®¿å†›' %}
                        {% elif player.promotion_status == 'runner_up' %}
                        {% set rank_name = 'äºšå†›' %}
                        {% elif player.promotion_status == 'champion' %}
                        {% set rank_name = 'å† å†›' %}
                        {% endif %}
                        <div class="celebration">
                            <div class="rocket"></div>
                            <div class="spark spark-1"></div>
                            <div class="spark spark-2"></div>
                            <div class="spark spark-3"></div>
                            <div class="spark spark-4"></div>
                            <div class="spark spark-5"></div>
                            <div class="spark spark-6"></div>
                            <div class="spark spark-7"></div>
                            <div class="spark spark-8"></div>
                        </div>
                        <div class="alert alert-success">
                            <h5 class="mb-1">ğŸ‰ æ­å–œæ‚¨è·å¾—èƒœåˆ©ï¼</h5>
                            <p class="mb-1">æ‚¨çš„åæ¬¡æ˜¯ï¼š<strong>{{ rank_name }}</strong>ã€‚</p>
                            <p class="mb-1">è¯·åˆ°åœºåŠ¡å¤„é¢†å–å¯¹åº”å¥–å“ã€‚</p>
                            <div class="final-score">
                                ç¬¬ä¸€è½®æˆç»©: {{ player.score_round1 }}<br>
                                {% if player.score_revival is not none %}
                                å¤æ´»èµ›æˆç»©: {{ player.score_revival }}
                                {% endif %}
                            </div>
                        </div>

                        {% elif player.score_round1 is not none and player.promotion_status == 'none' %}
                        <div class="alert alert-info">
                            <h5 class="mb-1">âŒ› æˆç»©å·²æäº¤</h5>
                            <p class="mb-1">å·¥ä½œäººå‘˜æ­£åœ¨ç»Ÿè®¡æˆç»©ï¼Œè¯·ç­‰å¾…æ™‹çº§ç»“æœå…¬å¸ƒã€‚</p>
                            <p class="small mb-0">
                                ç¬¬ä¸€è½®æˆç»©ï¼š{{ player.score_round1 }}
                            </p>
                        </div>

                        {% elif player.score_round1 is not none and player.promotion_status == 'eliminated' %}
                        <div class="alert alert-danger">
                            <h5 class="mb-1">ğŸ’” æ‚¨æœªèƒ½è¿›å…¥ 16 å¼ºã€‚</h5>
                            <p class="mb-1">æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œæ‚¨ä»ç„¶å¯ä»¥é¢†å–å‚ä¸å¥–å¹¶ç»§ç»­è§‚èµ›ï¼</p>
                            <p class="small mb-0">
                                ç¬¬ä¸€è½®æˆç»©ï¼š{{ player.score_round1 }}
                            </p>
                        </div>

                        {% else %}
                        <div class="alert alert-warning">
                            <h5 class="mb-0">è¯·ç­‰å¾…ç®¡ç†å‘˜æ“ä½œ</h5>
                            <p class="small mb-0">æ‚¨å·²ç­¾åˆ°ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹æœ€æ–°çŠ¶æ€ã€‚</p>
                        </div>
                        {% endif %}
                    </div>
                </section>

                <!-- å³ä¾§ï¼šæ¶ˆæ¯æç¤º / åˆ·æ–°è¯´æ˜ç­‰ -->
                <section class="status-card">
                    <h2 class="status-title">
                        ç°åœºé€šçŸ¥ä¸ç³»ç»Ÿæç¤º
                    </h2>
                    <p class="status-sub">
                        å¦‚ç³»ç»Ÿæœ‰å¼‚å¸¸ã€éœ€è¦é‡æ–°ç­¾åˆ°æˆ–è°ƒæ•´ï¼Œè¯·ç•™æ„ä¸‹æ–¹æç¤ºä¿¡æ¯ã€‚
                    </p>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="alert alert-info">
                        å½“å‰æš‚æ— ç³»ç»Ÿå¼‚å¸¸æç¤ºã€‚è‹¥æ¯”èµ›å®‰æ’æœ‰å˜æ›´ï¼Œå°†é€šè¿‡æ­¤å¤„æˆ–ç°åœºå¹¿æ’­åŒæ­¥ã€‚
                    </div>
                    {% endif %}
                    {% endwith %}

                    <div class="mt-3 border-top pt-3">
                        <button id="btn-forfeit-global" class="btn btn-outline-danger btn-sm w-100" type="button">
                            ğŸ³ï¸ å¼ƒæƒ / Forfeit
                        </button>
                    </div>

                    <div class="mt-2 small text-muted">
                        Â· å¦‚ç•Œé¢é•¿æ—¶é—´æ— å˜åŒ–ï¼Œå¯å°è¯•ç‚¹å‡»æµè§ˆå™¨åˆ·æ–°ã€‚<br>
                        Â· è‹¥å‘ç°è‡ªèº«ä¿¡æ¯ä¸æŠ¥åè¡¨ä¸ç¬¦ï¼Œè¯·å°½å¿«è”ç³»ç°åœºå·¥ä½œäººå‘˜ã€‚
                    </div>
                </section>
            </div>

            {% endif %}
            {% if not player %}
            <!-- æœªç™»å½•é€‰æ‰‹ï¼šå±…ä¸­ä¸€ä¸ªä¸»å¡ç‰‡ -->
            <div class="row justify-content-center">
                <div class="col-md-7 col-lg-6">
                    <div class="status-card position-relative overflow-hidden">
                        <h2 class="status-title">æœ¯åŠ›å£å¤§èµ›ç­¾åˆ°</h2>
                        <p class="status-sub" id="auth-subtitle">
                            è¯·åœ¨ä¸‹æ–¹è¾“å…¥æŠ¥åæ—¶å¡«å†™çš„å§“åï¼Œç”¨äºç­¾åˆ°æˆ–æŸ¥çœ‹å½“å‰æ¯”èµ›çŠ¶æ€ã€‚
                        </p>

                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                        {% endif %}
                        {% endwith %}

                        <!-- Step 1: è¾“å…¥å§“å -->
                        <div id="auth-step-name" class="auth-step">
                            <form id="form-check-name" onsubmit="handleCheckName(event)">
                                <div class="mb-3">
                                    <input type="text" id="input-name" class="form-control form-control-lg"
                                        placeholder="è¯·è¾“å…¥æ‚¨çš„æŠ¥åå§“å" required autocomplete="username">
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="btn-check-name">
                                    ä¸‹ä¸€æ­¥ <i class="bi bi-arrow-right"></i>
                                </button>
                            </form>
                        </div>

                        <!-- Step 2: ç™»å½• (å·²æ³¨å†Œ) -->
                        <div id="auth-step-login" class="auth-step d-none">
                            <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                                <div class="avatar-preview-small me-2">
                                    <img id="login-avatar-img" src="" class="rounded-circle d-none" width="40" height="40" style="object-fit: cover;">
                                    <span id="login-avatar-placeholder" class="rounded-circle bg-secondary d-inline-block" style="width: 40px; height: 40px;"></span>
                                </div>
                                <div>
                                    <div class="fw-bold" id="login-name-display"></div>
                                    <div class="small text-muted">æ¬¢è¿å›æ¥ï¼Œè¯·éªŒè¯å¯†ç </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-link ms-auto text-decoration-none" onclick="resetAuth()">åˆ‡æ¢è´¦å·</button>
                            </div>
                            <form id="form-login" onsubmit="handleLogin(event)">
                                <div class="mb-3">
                                    <input type="password" id="login-password" class="form-control form-control-lg"
                                        placeholder="è¯·è¾“å…¥å¯†ç " required autocomplete="current-password">
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="btn-login">
                                    ç™»å½• <i class="bi bi-box-arrow-in-right"></i>
                                </button>
                            </form>
                        </div>

                        <!-- Step 3: æ³¨å†Œ (é¦–æ¬¡ç™»å½•) -->
                        <div id="auth-step-register" class="auth-step d-none">
                            <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                                <div class="fw-bold fs-5" id="register-name-display"></div>
                                <div class="ms-2 badge bg-success">é¦–æ¬¡æ¿€æ´»</div>
                                <button type="button" class="btn btn-sm btn-link ms-auto text-decoration-none" onclick="resetAuth()">è¿”å›</button>
                            </div>
                            <div class="alert alert-info py-2 small">
                                <i class="bi bi-info-circle"></i> ä¸ºäº†æ‚¨çš„è´¦å·å®‰å…¨ï¼Œåˆæ¬¡ç™»å½•è¯·è®¾ç½®å¯†ç å¹¶ä¸Šä¼ å¤´åƒã€‚
                            </div>
                            <form id="form-register" onsubmit="handleRegister(event)">
                                <div class="mb-3">
                                    <label class="form-label">è®¾ç½®å¯†ç </label>
                                    <input type="password" id="reg-password" class="form-control" placeholder="è¯·è®¾ç½®ç™»å½•å¯†ç " required autocomplete="new-password">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ç¡®è®¤å¯†ç </label>
                                    <input type="password" id="reg-password-confirm" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required autocomplete="new-password">
                                    <div class="invalid-feedback" id="reg-pwd-error">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ä¸Šä¼ å¤´åƒ (å¯é€‰)</label>
                                    <input type="file" id="reg-avatar" class="form-control" accept="image/*" onchange="previewAvatar(this)">
                                    <div class="mt-2 text-center d-none" id="avatar-preview-container">
                                        <img id="avatar-preview-img" src="" class="rounded-circle shadow-sm" width="80" height="80" style="object-fit: cover;">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success btn-lg w-100" id="btn-register">
                                    æ¿€æ´»è´¦å·å¹¶ç­¾åˆ°
                                </button>
                            </form>
                        </div>

                        <div class="mt-3 small text-muted text-center">
                            Â· å¦‚å¿˜è®°å½“æ—¶æŠ¥åä½¿ç”¨çš„åå­—ï¼Œè¯·è”ç³»æŠ¥åå¤„æˆ–èµ›äº‹å§”å‘˜ä¼šå·¥ä½œäººå‘˜ã€‚<br>
                            Â· è‹¥å¤šæ¬¡è¾“å…¥ä»æç¤ºâ€œæœªæ‰¾åˆ°è¯¥é€‰æ‰‹â€ï¼Œè¯·æ ¸å¯¹æ˜¯å¦è·¨ç»„æŠ¥åæˆ–é‡åæƒ…å†µã€‚
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auth Logic Script -->
            <script>
                const authState = {
                    name: ''
                };

                function resetAuth() {
                    document.getElementById('auth-step-name').classList.remove('d-none');
                    document.getElementById('auth-step-login').classList.add('d-none');
                    document.getElementById('auth-step-register').classList.add('d-none');
                    document.getElementById('input-name').value = '';
                    document.getElementById('login-password').value = '';
                    document.getElementById('reg-password').value = '';
                    document.getElementById('reg-password-confirm').value = '';
                    document.getElementById('reg-avatar').value = '';
                    document.getElementById('avatar-preview-container').classList.add('d-none');
                    document.getElementById('auth-subtitle').textContent = 'è¯·åœ¨ä¸‹æ–¹è¾“å…¥æŠ¥åæ—¶å¡«å†™çš„å§“åï¼Œç”¨äºç­¾åˆ°æˆ–æŸ¥çœ‹å½“å‰æ¯”èµ›çŠ¶æ€ã€‚';
                }

                function handleCheckName(e) {
                    e.preventDefault();
                    const nameInput = document.getElementById('input-name');
                    const name = nameInput.value.trim();
                    if (!name) return;

                    const btn = document.getElementById('btn-check-name');
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æŸ¥è¯¢ä¸­...';

                    fetch('/api/auth/check_status', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name: name})
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            // API Response: {success: true, data: {exists: bool, ...}}
                            const data = res.data || {};
                            if (!data.exists) {
                                alert('æœªæ‰¾åˆ°è¯¥é€‰æ‰‹ï¼Œè¯·ç¡®è®¤å§“åæ˜¯å¦æ­£ç¡®ã€‚');
                            } else {
                                authState.name = name;
                                document.getElementById('auth-step-name').classList.add('d-none');
                                if (data.registered) {
                                    // Go to Login
                                    document.getElementById('auth-step-login').classList.remove('d-none');
                                    document.getElementById('login-name-display').textContent = name;
                                    document.getElementById('auth-subtitle').textContent = 'è¯·è¾“å…¥å¯†ç ç™»å½•ã€‚';
                                    
                                    const avatarImg = document.getElementById('login-avatar-img');
                                    const avatarHolder = document.getElementById('login-avatar-placeholder');
                                    if (data.avatar_url) {
                                        avatarImg.src = data.avatar_url;
                                        avatarImg.classList.remove('d-none');
                                        avatarHolder.classList.add('d-none');
                                    } else {
                                        avatarImg.classList.add('d-none');
                                        avatarHolder.classList.remove('d-none');
                                    }
                                    // Auto focus password
                                    setTimeout(() => document.getElementById('login-password').focus(), 100);
                                } else {
                                    // Go to Register
                                    document.getElementById('auth-step-register').classList.remove('d-none');
                                    document.getElementById('register-name-display').textContent = name;
                                    document.getElementById('auth-subtitle').textContent = 'æ¬¢è¿æ‚¨ï¼è¯·å®Œå–„è´¦å·ä¿¡æ¯ä»¥å®Œæˆç­¾åˆ°ã€‚';
                                }
                            }
                        } else {
                            alert(res.message || res.msg || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                    })
                    .finally(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    });
                }

                function handleLogin(e) {
                    e.preventDefault();
                    const pwd = document.getElementById('login-password').value;
                    const btn = document.getElementById('btn-login');
                    
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ç™»å½•ä¸­...';

                    fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name: authState.name, password: pwd})
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            window.location.reload();
                        } else {
                            alert(res.message || res.msg || 'ç™»å½•å¤±è´¥');
                            btn.disabled = false;
                            btn.innerHTML = 'ç™»å½• <i class="bi bi-box-arrow-in-right"></i>';
                        }
                    })
                    .catch(() => {
                        alert('ç½‘ç»œé”™è¯¯');
                        btn.disabled = false;
                        btn.innerHTML = 'ç™»å½• <i class="bi bi-box-arrow-in-right"></i>';
                    });
                }

                function handleRegister(e) {
                    e.preventDefault();
                    const pwd = document.getElementById('reg-password').value;
                    const pwdConfirm = document.getElementById('reg-password-confirm').value;
                    
                    if (pwd !== pwdConfirm) {
                        document.getElementById('reg-password-confirm').classList.add('is-invalid');
                        document.getElementById('reg-pwd-error').style.display = 'block';
                        return;
                    } else {
                        document.getElementById('reg-password-confirm').classList.remove('is-invalid');
                        document.getElementById('reg-pwd-error').style.display = 'none';
                    }

                    const btn = document.getElementById('btn-register');
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æäº¤ä¸­...';

                    const formData = new FormData();
                    formData.append('name', authState.name);
                    formData.append('password', pwd);
                    const fileInput = document.getElementById('reg-avatar');
                    if (fileInput.files[0]) {
                        formData.append('avatar', fileInput.files[0]);
                    }

                    fetch('/api/auth/register', {
                        method: 'POST',
                        body: formData
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            alert('æ³¨å†ŒæˆåŠŸï¼');
                            window.location.reload();
                        } else {
                            alert(res.message || res.msg || 'æ³¨å†Œå¤±è´¥');
                            btn.disabled = false;
                            btn.innerHTML = 'æ¿€æ´»è´¦å·å¹¶ç­¾åˆ°';
                        }
                    })
                    .catch(() => {
                        alert('ç½‘ç»œé”™è¯¯');
                        btn.disabled = false;
                        btn.innerHTML = 'æ¿€æ´»è´¦å·å¹¶ç­¾åˆ°';
                    });
                }

                function previewAvatar(input) {
                    const container = document.getElementById('avatar-preview-container');
                    const img = document.getElementById('avatar-preview-img');
                    if (input.files && input.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            img.src = e.target.result;
                            container.classList.remove('d-none');
                        }
                        reader.readAsDataURL(input.files[0]);
                    } else {
                        container.classList.add('d-none');
                    }
                }

                // Check for UID in URL (Magic Link)
                document.addEventListener('DOMContentLoaded', () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const uid = urlParams.get('uid');
                    if (uid) {
                        fetch(`/api/v1/player/${uid}`)
                            .then(r => r.json())
                            .then(res => {
                                if (res.success && res.data) {
                                    const name = res.data.name;
                                    document.getElementById('input-name').value = name;
                                    // Trigger check name
                                    document.getElementById('btn-check-name').click();
                                }
                            });
                    }
                });
            </script>
            {% endif %}

        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}

{% if player %}
<script>
    (function () {
        // é€‰æ‰‹çŠ¶æ€è½®è¯¢ï¼Œç”¨äºå†³å®šæ˜¯å¦åˆ·æ–°æ•´é¡µ + æ¯”èµ›å¼€å§‹çŠ¶æ€æ§åˆ¶
        let lastSnapshot = null;
        const POLL_INTERVAL_MS = 5000;
        const overlay = document.getElementById('player-block-overlay');
        const overlayTitle = document.getElementById('player-block-title');
        const overlayDesc = document.getElementById('player-block-desc');

        function poll() {
            fetch("{{ url_for('player_state_api') }}", { cache: "no-store" })
                .then(resp => {
                    if (!resp.ok) throw new Error("status " + resp.status);
                    return resp.json();
                })
                .then(data => {
                    // 1. Check Match Started
                    if (data.ok) {
                        if (!data.match_started) {
                            showOverlay("æ¯”èµ›æœªå¼€å§‹", "è¯·æ‚¨è€å¿ƒç­‰å¾…ï¼");
                        } else if (data.promotion_status === 'timeout_eliminated') {
                            showOverlay("å–æ¶ˆå‚èµ›èµ„æ ¼", "æ‚¨æœªèƒ½åœ¨ç­¾åˆ°æˆªæ­¢å‰åˆ°è¾¾æ¯”èµ›ç°åœºï¼Œå·²å–æ¶ˆæ‚¨çš„å‚èµ›èµ„æ ¼ã€‚");
                        } else if (data.forfeited && data.promotion_status !== 'timeout_eliminated') {
                            // æ‰‹åŠ¨å¼ƒèµ›ï¼Œé€šå¸¸ä¼šæ˜¾ç¤ºé¡µé¢ä¸Šçš„ Alertï¼Œä½†å¦‚æœéœ€è¦å…¨å±é®ç½©ä¹Ÿå¯ä»¥ï¼Œ
                            // ä½†ç”¨æˆ·è¯´"æ‰‹åŠ¨å¼ƒèµ›çš„é€‰æ‰‹ä¼šåœ¨é€‰æ‰‹ç«¯æ˜¾ç¤ºï¼šæ‚¨å·²æ‰‹åŠ¨å¼ƒæƒ..."
                            // å¹¶æ²¡æœ‰æ˜ç¡®è¯´è¦å…¨å±é®ç½©ï¼Œä½†"è¶…æ—¶æœªç­¾åˆ°çš„é€‰æ‰‹å°†ä¼šæ˜¾ç¤º..."
                            // å‡è®¾æ‰‹åŠ¨å¼ƒæƒåªéœ€è¦æ˜¾ç¤º Alert (å·²æœ‰é€»è¾‘)ï¼Œæˆ–è€…å¦‚æœç”¨æˆ·è¿˜åœ¨é¡µé¢ä¸Šï¼Œ
                            // ä¹‹å‰çš„é€»è¾‘æ˜¯ Alertã€‚
                            // ä½†ç”¨æˆ·è¯´"æ‰‹åŠ¨å¼ƒèµ›çš„é€‰æ‰‹ä¼šåœ¨é€‰æ‰‹ç«¯æ˜¾ç¤ºï¼šæ‚¨å·²æ‰‹åŠ¨å¼ƒæƒ...è¶…æ—¶æœªç­¾åˆ°çš„é€‰æ‰‹å°†ä¼šæ˜¾ç¤º..."
                            // è¿™å¯èƒ½æ„å‘³ç€ä¸¤è€…éƒ½éœ€è¦æ˜¾è‘—æç¤ºã€‚
                            // ä¸ºäº†ç¨³å¦¥ï¼Œæ‰‹åŠ¨å¼ƒèµ›ä¹Ÿç”¨ Overlay?
                            // "æ‰‹åŠ¨å¼ƒèµ›çš„é€‰æ‰‹ä¼šåœ¨é€‰æ‰‹ç«¯æ˜¾ç¤ºï¼šæ‚¨å·²æ‰‹åŠ¨å¼ƒæƒã€‚å¾ˆé—æ†¾æ‚¨æœªèƒ½å‚ä¸æ•´åœºæ¯”èµ›ï¼Œä½†æˆ‘ä»¬ä»ç„¶æ¬¢è¿æ‚¨ä¸‹æ¬¡ç»§ç»­å‚ä¸ï¼"
                            // æ—¢ç„¶æ–‡æ¡ˆè¿™ä¹ˆé•¿ï¼ŒOverlay æ¯”è¾ƒåˆé€‚ã€‚
                            // ä½†åŸæ¥çš„é¡µé¢ä¹Ÿæœ‰å¼ƒæƒçŠ¶æ€æ˜¾ç¤ºã€‚
                            // æˆ‘ä¼šåŠ ä¸Š Overlayã€‚
                            // åªæœ‰å½“ forfeited ä¸º true ä¸” promotion_status ä¸æ˜¯ timeout_eliminated æ—¶ï¼ˆå³æ‰‹åŠ¨ï¼‰
                            // å®é™…ä¸Š Player.forfeited å­—æ®µæ¶µç›–ä¸¤è€…ã€‚
                            // æˆ‘éœ€è¦åŒºåˆ†ã€‚
                            // ä¹‹å‰çš„ä»£ç ï¼šstatusText logic in Android distinguishes them.
                            // Here I can distinguish by promotion_status.
                            // If forfeited=True and promotion_status != 'timeout_eliminated', it's manual.
                            // If forfeited=True and promotion_status == 'timeout_eliminated', it's timeout.
                            
                            // å®é™…ä¸Šå¦‚æœ forfeitedï¼Œé¡µé¢å†…å®¹å¯èƒ½å·²ç»å˜åŒ–ã€‚
                            // å¦‚æœæˆ‘åŠ äº† Overlayï¼Œç”¨æˆ·å°±ä¸èƒ½æ“ä½œä»»ä½•ä¸œè¥¿äº†ï¼ˆé™¤äº†é€€å‡ºç™»å½•ï¼ŸOverlay åº”è¯¥åœ¨ m3-shell å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨ï¼Ÿï¼‰
                            // CSS fixed cover, z-index 10000. It covers everything.
                            // ç”¨æˆ·å¯èƒ½æƒ³é€€å‡ºç™»å½•ã€‚
                            // åº”è¯¥å…è®¸é€€å‡ºç™»å½•ã€‚
                            // ä½† Overlay è¦†ç›–å…¨å±ã€‚
                            // æˆ‘å¯ä»¥åœ¨ Overlay é‡ŒåŠ ä¸ªé€€å‡ºç™»å½•æŒ‰é’®ï¼Ÿ
                            // æˆ–è€…è®© Overlay ä½äº Navbar ä¸‹æ–¹ï¼Ÿ
                            // ä¹‹å‰çš„ CSS top:0, left:0, z-index:10000 è¦†ç›–å…¨å±ã€‚
                            // ç®—äº†ï¼Œå…ˆè¦†ç›–å…¨å±ï¼Œå¦‚æœç”¨æˆ·æƒ³é€€å‡ºï¼Œåªèƒ½åˆ·æ–°ï¼Ÿæˆ–è€…æˆ‘åœ¨ Overlay é‡ŒåŠ ä¸ªé“¾æ¥ã€‚
                            
                            // showOverlay("æ‚¨å·²æ‰‹åŠ¨å¼ƒæƒ", "å¾ˆé—æ†¾æ‚¨æœªèƒ½å‚ä¸æ•´åœºæ¯”èµ›ï¼Œä½†æˆ‘ä»¬ä»ç„¶æ¬¢è¿æ‚¨ä¸‹æ¬¡ç»§ç»­å‚ä¸ï¼");
                             // å®é™…ä¸Šç”¨æˆ·è¯´"æ‰‹åŠ¨å¼ƒèµ›çš„é€‰æ‰‹ä¼šåœ¨é€‰æ‰‹ç«¯æ˜¾ç¤º..."
                             // æˆ‘ä¼šåŠ ä¸Šè¿™ä¸ª Overlayã€‚
                             // ä½†æ˜¯è¦æ³¨æ„ï¼Œå¦‚æœç”¨æˆ·æ˜¯åœ¨æ¯”èµ›ä¸­é€”å¼ƒæƒï¼Œå¯èƒ½æƒ³çœ‹æ¯”èµ›ç»“æœï¼Ÿ
                             // å¦‚æœè¦†ç›–äº†ï¼Œå°±çœ‹ä¸äº†äº†ã€‚
                             // "æ‰‹åŠ¨å¼ƒèµ›çš„é€‰æ‰‹ä¼šåœ¨é€‰æ‰‹ç«¯æ˜¾ç¤º...è€Œè¶…æ—¶æœªç­¾åˆ°çš„é€‰æ‰‹å°†ä¼šæ˜¾ç¤º..."
                             // è¿™å¬èµ·æ¥åƒæ˜¯ä¸€ä¸ªå…¨å±çš„çŠ¶æ€é¡µã€‚
                             // æˆ‘å°†å¯¹è¿™ä¸¤ç§æƒ…å†µéƒ½æ˜¾ç¤º Overlayã€‚
                             
                             // ä½†å¯¹äºæ‰‹åŠ¨å¼ƒæƒï¼ŒåŸæ¥çš„é€»è¾‘æ˜¯æ˜¾ç¤º Alertã€‚
                             // å¦‚æœæˆ‘åŠ äº† Overlayï¼ŒåŸæ¥çš„ Alert å°±çœ‹ä¸åˆ°äº†ã€‚
                             // é‰´äºç”¨æˆ·çš„æ˜ç¡®æ–‡æ¡ˆè¦æ±‚ï¼ŒOverlay æ˜¯æœ€å®‰å…¨çš„æ–¹å¼ã€‚
                        } else {
                            hideOverlay();
                        }
                    }

                    // 2. Refresh Check
                    // Remove match_started from snapshot comparison to avoid reload loop if only that changes?
                    // No, if match starts, we want to reload to remove overlay (or just hide it via JS above).
                    // If I hide it via JS, I don't strictly need to reload, but reloading is safer to update UI state.
                    // However, if I handle overlay via JS, reload isn't strictly necessary for that feature.
                    // But other things might change.
                    const jsonStr = JSON.stringify(data);
                    if (lastSnapshot === null) {
                        lastSnapshot = jsonStr;
                    } else if (lastSnapshot !== jsonStr) {
                        // å¦‚æœåªæ˜¯ match_started å˜åŒ–ï¼ŒJS å·²ç»å¤„ç†äº† Overlayã€‚
                        // æ˜¯å¦ reloadï¼Ÿ
                        // å¦‚æœ match_started å˜ä¸º trueï¼Œé¡µé¢å¯èƒ½éœ€è¦æ˜¾ç¤º"ç­¾åˆ°"æŒ‰é’®æˆ–è€…"ä¸Šæœº"æŒ‰é’®ï¼ˆå¦‚æœä¹‹å‰è¢«éšè—ï¼‰ã€‚
                        // æœ€å¥½ reloadã€‚
                        window.location.reload();
                    }
                })
                .catch(err => { })
                .finally(() => {
                    setTimeout(poll, POLL_INTERVAL_MS);
                });
        }

        function showOverlay(title, desc) {
            if (overlay) {
                overlayTitle.textContent = title;
                overlayDesc.textContent = desc;
                overlay.style.display = 'flex';
            }
        }

        function hideOverlay() {
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        poll();
    })();
</script>
{% endif %}

{% if player %}
<script>
    (function () {
        const panel = document.getElementById('song-draw-player-panel');
        if (!panel) return;

        const statusEl = document.getElementById('song-draw-player-status');
        const phaseEl = document.getElementById('song-draw-player-phase');
        const tipEl = document.getElementById('song-draw-player-tip');

        // ç¬¬ 1 é¦–
        const imgEl1 = document.getElementById('song-draw-player-image');
        const nameEl1 = document.getElementById('song-draw-player-name');

        // ç¬¬ 2 é¦–ï¼ˆå¤–å±‚ slot ç”¨æ¥æ•´ä½“éšè—/æ˜¾ç¤ºï¼‰
        const slot2 = document.getElementById('song-draw-player-slot-2');
        const imgEl2 = document.getElementById('song-draw-player-image-2');
        const nameEl2 = document.getElementById('song-draw-player-name-2');

        const playerGroup = "{{ player.group }}";  // beginner / advanced

        function phaseToLabel(phase) {
            if (phase === 'qualifier') return 'æµ·é€‰èµ›';
            if (phase === 'revival') return 'å¤æ´»èµ›';
            if (phase === 'semifinal') return 'åŠå†³èµ›';
            if (phase === 'final') return 'å†³èµ›';
            return '';
        }
        function groupToLabel(group) {
            if (group === 'beginner') return 'èŒæ–°ç»„';
            if (group === 'advanced') return 'è¿›é˜¶ç»„';
            return '';
        }

        // æ¸…ç©ºä¸¤ä¸ªæ§½ä½
        function resetSlots() {
            if (nameEl1) nameEl1.textContent = '';
            if (nameEl2) nameEl2.textContent = '';

            if (imgEl1) {
                imgEl1.src = '';
                imgEl1.classList.add('d-none');
            }
            if (imgEl2) {
                imgEl2.src = '';
                imgEl2.classList.add('d-none');
            }
            if (slot2) {
                slot2.classList.add('d-none');
            }
        }

        // ç»Ÿä¸€è·å–å·²é€‰æ›²ç›®ï¼ˆå« image_urlï¼‰
        function getSelectedSongsFromState(data) {
            if (!data) return [];

            let selectedList = [];

            if (Array.isArray(data.selected_songs) && data.selected_songs.length > 0) {
                selectedList = data.selected_songs.slice();
            } else if (data.selected_song) {
                selectedList = [data.selected_song];
            }

            if ((!selectedList || selectedList.length === 0) &&
                Array.isArray(data.selected_song_ids) &&
                Array.isArray(data.songs)) {

                const idSet = new Set(
                    data.selected_song_ids.map(x => String(x))
                );
                selectedList = data.songs.filter(
                    s => idSet.has(String(s.id))
                );
            }

            if (Array.isArray(data.songs) && data.songs.length > 0 && selectedList.length > 0) {
                const byId = new Map(
                    data.songs.map(s => [String(s.id), s])
                );
                selectedList = selectedList.map(s => {
                    const full = byId.get(String(s.id));
                    return full ? full : s;
                });
            }

            return selectedList;
        }

        // --- å¼ƒæƒ & æ¯”èµ›ä¿¡æ¯è½®è¯¢ ---
        (function () {
            const playerId = {{ player.id }};
        const matchCard = document.getElementById('match-info-card');
        const matchPhaseBadge = document.getElementById('match-phase-badge');
        const opNameEl = document.getElementById('match-opponent-name');
        const opInfoEl = document.getElementById('match-opponent-info');
        const opForfeitEl = document.getElementById('match-opponent-forfeited');

        const peakPanel = document.getElementById('peak-control-panel');
        const mySongText = document.getElementById('my-peak-song-text');
        const btnOpenPeak = document.getElementById('btn-open-peak-modal');
        const opSongText = document.getElementById('op-peak-song-text');
        const btnBanPeak = document.getElementById('btn-ban-peak');
        const badgeBanned = document.getElementById('badge-peak-banned');

        // å¼ƒæƒæŒ‰é’®é€»è¾‘
        const btnForfeit = document.getElementById('btn-forfeit-global');
        if (btnForfeit) {
            btnForfeit.addEventListener('click', function (e) {
                e.preventDefault();
                if (confirm("âš ï¸ ç¡®å®šè¦å¼ƒæƒå—ï¼Ÿ\nå¼ƒæƒåæ‚¨å°†ç›´æ¥åˆ¤è´Ÿï¼Œä¸”æ— æ³•æ¢å¤ï¼å¦‚æœæ‚¨æ­£åœ¨è¿›è¡Œ 1v1 å¯¹æˆ˜ï¼Œå¯¹æ‰‹å°†ç›´æ¥æ™‹çº§ã€‚")) {
                    fetch(`/api/v1/player/${playerId}/forfeit`, { method: 'POST' })
                        .then(r => r.json())
                        .then(d => {
                            if (d.success) {
                                alert('å·²ç¡®è®¤å¼ƒæƒã€‚');
                                window.location.reload();
                            } else {
                                alert('æ“ä½œå¤±è´¥: ' + d.message);
                            }
                        });
                }
            });
        }

        // å·…å³°ç»„ Modal
        const peakModal = new bootstrap.Modal(document.getElementById('peakSongModal'));
        document.getElementById('btn-submit-peak-confirm').addEventListener('click', function () {
            const name = document.getElementById('peak-song-name').value;
            const diff = document.getElementById('peak-song-diff').value;
            if (!name || !diff) return;

            fetch(`/api/v1/player/${playerId}/peak/submit_song`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ song_name: name, difficulty: parseInt(diff) })
            }).then(r => r.json()).then(d => {
                if (d.success) {
                    alert('æäº¤æˆåŠŸ');
                    peakModal.hide();
                    pollMatchInfo(); // refresh
                } else {
                    alert(d.message);
                }
            });
        });

        if (btnOpenPeak) {
            btnOpenPeak.addEventListener('click', () => peakModal.show());
        }

        if (btnBanPeak) {
            btnBanPeak.addEventListener('click', () => {
                if (confirm("ç¡®å®šè¦ BAN æ‰å¯¹æ–¹è¿™é¦–æ›²ç›®å—ï¼Ÿæ¯åœºæ¯”èµ›ä»…é™ä¸€æ¬¡ï¼")) {
                    fetch(`/api/v1/player/${playerId}/peak/ban_song`, { method: 'POST' })
                        .then(r => r.json()).then(d => {
                            if (d.success) {
                                alert('BAN æˆåŠŸ');
                                pollMatchInfo();
                            } else {
                                alert(d.message);
                            }
                        });
                }
            });
        }

        function pollMatchInfo() {
            fetch(`/api/v1/player/${playerId}/match`)
                .then(r => r.json())
                .then(res => {
                    if (res.success && res.data) {
                        const m = res.data;
                        matchCard.classList.remove('d-none');
                        matchPhaseBadge.textContent = m.phase + (m.group === 'peak' ? ' (Peak)' : '');

                        opNameEl.textContent = m.opponent.name;
                        opInfoEl.textContent = m.opponent.rating ? `Rating: ${m.opponent.rating}` : '';

                        if (m.opponent.forfeited) {
                            opForfeitEl.classList.remove('d-none');
                        } else {
                            opForfeitEl.classList.add('d-none');
                        }

                        // å·…å³°ç»„é€»è¾‘
                        if (m.group === 'peak') {
                            peakPanel.classList.remove('d-none');

                            // æˆ‘æ–¹
                            if (m.my_selection) {
                                mySongText.textContent = `${m.my_selection.song_name} (Lv.${m.my_selection.difficulty})`;
                                btnOpenPeak.classList.add('d-none');
                            } else {
                                if (m.was_banned) {
                                    mySongText.innerHTML = `<span class="text-danger">æ‚¨çš„æ›²ç›®è¢« Banï¼Œè¯·é‡æ–°æäº¤ï¼</span>`;
                                } else {
                                    mySongText.textContent = "æœªæäº¤";
                                }
                                btnOpenPeak.classList.remove('d-none');
                            }

                            // å¯¹æ–¹
                            if (m.op_selection) {
                                if (m.op_selection.hidden) {
                                    opSongText.textContent = "å·²æäº¤ (ç­‰å¾…æ‰€æœ‰é€‰æ‰‹å®Œæˆ...)";
                                    opSongText.classList.add('text-muted');
                                    btnBanPeak.classList.add('d-none'); // éšè—æ—¶ä¸å¯ Ban
                                } else {
                                    opSongText.textContent = `${m.op_selection.song_name} (Lv.${m.op_selection.difficulty})`;
                                    opSongText.classList.remove('text-muted');

                                    // Ban é€»è¾‘
                                    if (m.has_banned_this_match) {
                                        btnBanPeak.classList.add('d-none');
                                        badgeBanned.classList.remove('d-none');
                                    } else if (!m.ban_used) {
                                        // æ²¡ç”¨è¿‡ Banï¼Œä¸”å¯¹æ–¹é€‰äº†æ­Œ -> æ˜¾ç¤º Ban æŒ‰é’®
                                        btnBanPeak.classList.remove('d-none');
                                        badgeBanned.classList.add('d-none');
                                    } else {
                                        // ç”¨è¿‡ Ban (éæœ¬åœº) -> ä¹Ÿä¸æ˜¾ç¤º
                                        btnBanPeak.classList.add('d-none');
                                        badgeBanned.classList.add('d-none');
                                    }
                                }
                            } else {
                                opSongText.textContent = "ç­‰å¾…å¯¹æ–¹...";
                                opSongText.classList.add('text-muted');
                                btnBanPeak.classList.add('d-none');
                                badgeBanned.classList.add('d-none');
                            }
                        } else {
                            peakPanel.classList.add('d-none');
                        }
                    } else {
                        // è‹¥ä¸ºå·…å³°ç»„ä¸”å¤„äº 4â†’2 æˆ– å†³èµ›é˜¶æ®µï¼Œä½†å°šæœªç”Ÿæˆå¯¹é˜µï¼Œæç¤ºç­‰å¾…
                        const playerGroup = "{{ player.group }}";
                        const promo = "{{ player.promotion_status }}";
                        if (playerGroup === 'peak' && (promo === 'top4_peak' || promo === 'final')) {
                            matchCard.classList.remove('d-none');
                            matchPhaseBadge.textContent = (promo === 'final' ? 'final' : 'top4') + ' (Peak)';
                            opNameEl.textContent = '--';
                            opInfoEl.textContent = '';
                            opForfeitEl.classList.add('d-none');
                            peakPanel.classList.remove('d-none');
                            mySongText.textContent = 'ç­‰å¾…åå°ç”Ÿæˆå¯¹é˜µåå¯æäº¤è‡ªé€‰æ›²';
                            btnOpenPeak.classList.remove('d-none');
                            opSongText.textContent = 'ç­‰å¾…ç”Ÿæˆå¯¹é˜µ';
                            btnBanPeak.classList.add('d-none');
                            badgeBanned.classList.add('d-none');
                        } else {
                            matchCard.classList.add('d-none');
                        }
                    }
                })
                .catch(e => console.error(e))
                .finally(() => setTimeout(pollMatchInfo, 3000));
        }

        // Start polling
        pollMatchInfo();
    })();

    function renderSelectedSongs(list) {
        resetSlots();
        if (!list || list.length === 0) return;

        const s1 = list[0];
        if (s1) {
            if (nameEl1) nameEl1.textContent = s1.name || '';
            if (imgEl1) {
                if (s1.image_url) {
                    imgEl1.src = s1.image_url;
                    imgEl1.classList.remove('d-none');
                } else {
                    imgEl1.classList.add('d-none');
                }
            }
        }

        if (list.length >= 2) {
            const s2 = list[1];
            if (slot2) slot2.classList.remove('d-none');
            if (s2) {
                if (nameEl2) nameEl2.textContent = s2.name || '';
                if (imgEl2) {
                    if (s2.image_url) {
                        imgEl2.src = s2.image_url;
                        imgEl2.classList.remove('d-none');
                    } else {
                        imgEl2.classList.add('d-none');
                    }
                }
            }
        }
    }

    function poll() {
        fetch("{{ url_for('api_song_draw_state') }}", { cache: "no-store" })
            .then(resp => resp.json())
            .then(data => {
                if (!data || data.status === 'idle' ||
                    !data.phase || !data.group || !data.songs || data.songs.length === 0) {

                    panel.classList.add('d-none');
                    resetSlots();
                    return;
                }

                if (data.group !== playerGroup) {
                    panel.classList.add('d-none');
                    resetSlots();
                    return;
                }

                panel.classList.remove('d-none');

                const phaseLabel = phaseToLabel(data.phase);
                const groupLabel = groupToLabel(data.group);
                let labelText = '';
                if (phaseLabel) labelText += phaseLabel;
                if (groupLabel) labelText += ' Â· ' + groupLabel;
                phaseEl.textContent = labelText ? ('å½“å‰æŠ½é€‰ï¼š' + labelText) : '';

                if (data.status === 'rolling') {
                    statusEl.textContent = 'æ›²ç›®æŠ½é€‰ä¸­â€¦';
                    tipEl.textContent = 'è¯·å…¨ä½“é€‰æ‰‹å…±åŒè§è¯æŠ½é€‰è¿‡ç¨‹ï¼Œç»“æœå°†åœ¨æŠ½é€‰ç»“æŸåå…¬å¸ƒã€‚';
                    resetSlots();
                    return;
                }

                if (data.status === 'finished') {
                    statusEl.textContent = 'æŠ½é€‰å®Œæˆï¼Œæœ¬è½®æ¯”èµ›æ›²ç›®å¦‚ä¸‹ï¼š';
                    tipEl.textContent = 'è¯·ä»¥ä»¥ä¸‹æ›²ç›®ç»„åˆè¿›è¡Œæœ¬è½®æ¯”èµ›ã€‚';

                    const selectedList = getSelectedSongsFromState(data);
                    renderSelectedSongs(selectedList);
                } else {
                    resetSlots();
                    panel.classList.add('d-none');
                }
            })
            .catch(err => {
                console.warn('song_draw_state_api error:', err);
            })
            .finally(() => {
                setTimeout(poll, 1000);
            });
    }

    poll();
    }) ();
</script>
{% endif %}


<!-- Peak Song Modal -->
<div class="modal fade" id="peakSongModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æäº¤è‡ªé€‰æ›²ç›® (Peak Group)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">æ›²ç›®åç§°</label>
                    <input type="text" class="form-control" id="peak-song-name">
                </div>
                <div class="mb-3">
                    <label class="form-label">éš¾åº¦ç­‰çº§ (1-15)</label>
                    <input type="number" class="form-control" id="peak-song-diff">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btn-submit-peak-confirm">æäº¤</button>
            </div>
        </div>
    </div>
</div>
<div id="player-block-overlay" class="player-block-overlay" style="display: none;">
    <div class="player-block-icon mb-3">
        <i class="bi bi-hourglass-split" style="font-size: 48px; color: #0d6efd;"></i>
    </div>
    <div class="player-block-title" id="player-block-title">æ¯”èµ›æœªå¼€å§‹</div>
    <div class="player-block-desc" id="player-block-desc">è¯·æ‚¨è€å¿ƒç­‰å¾…ï¼</div>
</div>

{% endblock %}

<script>
    (function() {
        // æ— ç¼è½®è¯¢é€‰æ‰‹çŠ¶æ€
        const POLL_INTERVAL = 3000;
        
        // ç®€å•è¯»å– Cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        const playerId = getCookie('player_id');
        if (!playerId) return;

        function pollPlayerStatus() {
            fetch(`/api/v1/player/${playerId}`)
                .then(r => r.json())
                .then(d => {
                    if (d.success && d.data) {
                        updatePlayerUI(d.data);
                    }
                })
                .catch(console.warn)
                .finally(() => setTimeout(pollPlayerStatus, POLL_INTERVAL));
        }

        function updatePlayerUI(p) {
            // 1. æ›´æ–°åºå·
            const matchNumEl = document.getElementById('match-number-display');
            if (p.match_number && matchNumEl) {
                const currentText = matchNumEl.innerText.trim();
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯åºå·
                // å¦‚æœå½“å‰æ˜¯ "ç­‰å¾…åˆ†é…" æˆ–è€… ç°åœ¨çš„åºå·è·Ÿæ–°åºå·ä¸ä¸€æ ·ï¼Œå°±æ›´æ–°
                // æ³¨æ„ï¼šmatchNumEl é‡Œå¯èƒ½åªæ˜¾ç¤ºæ•°å­—ï¼Œä¹Ÿå¯èƒ½æ˜¾ç¤º "001"
                
                // ç®€å•çš„é€»è¾‘ï¼šå¦‚æœå½“å‰æ˜¾ç¤ºçš„å†…å®¹ä¸æ˜¯æ–°çš„åºå·ï¼ˆæ ¼å¼åŒ–åçš„ï¼‰ï¼Œå°±æ›´æ–°å¹¶æç¤º
                const newNumStr = String(p.match_number).padStart(3, '0');
                
                if (currentText !== newNumStr && !currentText.includes('ç­‰å¾…')) {
                     // ä¹‹å‰å·²ç»æœ‰åºå·äº†ï¼Œä½†æ˜¯å˜äº† -> å¼¹å‡ºæç¤º
                     // ä½¿ç”¨ alert æˆ–è€…æ›´å¥½çš„ toastã€‚è¿™é‡Œç®€å•ç”¨ alertï¼Œä½†ä¸ºäº†é¿å…é¢‘ç¹å¼¹çª—ï¼Œå¯ä»¥åŠ ä¸ªæ ‡å¿—ä½
                     // å®é™…ä¸Šï¼Œå¦‚æœç”¨æˆ·ä¸€ç›´åœ¨åˆ·æ–°é¡µé¢ï¼Œä¹Ÿä¸ä¼šè§¦å‘è¿™ä¸ªã€‚åªæœ‰è½®è¯¢è§¦å‘ã€‚
                     
                     // ä¸ºäº†é˜²æ­¢é¡µé¢åˆšåŠ è½½æ—¶ï¼ˆä»ç©ºåˆ°æœ‰ï¼‰ä¹Ÿå¼¹çª—ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•ä¸Šä¸€æ¬¡çš„åºå·
                     if (window.lastMatchNumber && window.lastMatchNumber !== p.match_number) {
                         alert(`ğŸ”” æ‚¨çš„æ¯”èµ›åºå·å·²æ›´æ–°ï¼\n\næ–°åºå·ï¼š#${p.match_number}`);
                     }
                }
                
                window.lastMatchNumber = p.match_number;
                matchNumEl.innerText = newNumStr;
            } else if (p.match_number) {
                // é¡µé¢å¯èƒ½æ²¡æœ‰ match-number-display å…ƒç´ ï¼ˆä¾‹å¦‚æ²¡ç­¾åˆ°æ—¶ï¼‰ï¼Œä½†å¦‚æœæœ‰æ•°æ®äº†
                window.lastMatchNumber = p.match_number;
            }

            // 2. æ›´æ–°ç­¾åˆ°çŠ¶æ€å¾½ç«  (å¦‚æœæœ‰)
            // é¡µé¢ç»“æ„ä¸­å¯èƒ½æ²¡æœ‰ä¸“é—¨çš„ IDï¼Œè¿™é‡Œä»…åšç¤ºä¾‹ï¼Œå®é™…éœ€è¦ç»“åˆ HTML ç»“æ„
            // æ¯”å¦‚ header æ—è¾¹çš„ status
            
            // 3. æ›´æ–°ä¸ŠæœºçŠ¶æ€
            // æŸ¥æ‰¾ "ä¸Šæœº / ä¸‹æœº" æŒ‰é’®
            // å‡è®¾æŒ‰é’®æœ‰ç‰¹å®š class æˆ– IDï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦å»åŠ ã€‚
            // ç°æœ‰ index.html æ˜¯åç«¯æ¸²æŸ“çš„ï¼ŒæŒ‰é’®çŠ¶æ€ç›´æ¥å†™æ­»åœ¨ HTML é‡Œã€‚
            // è¦å®ç°æ— ç¼æ›´æ–°ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ JS æ§åˆ¶è¿™ä¸ªæŒ‰é’®çš„æ˜¾ç¤ºã€‚
            
            // ç”±äº index.html ç»“æ„æ¯”è¾ƒå¤æ‚ä¸”å¤§é‡ä¾èµ– Jinja2 æ¸²æŸ“ï¼Œ
            // ç®€å•çš„æ–¹æ³•æ˜¯ï¼šå¦‚æœæ£€æµ‹åˆ°çŠ¶æ€å…³é”®å­—æ®µå˜åŒ–ï¼ˆchecked_in, on_machineï¼‰ï¼Œ
            // åˆ™è§¦å‘é¡µé¢åˆ·æ–° (fallback)ï¼Œæˆ–è€…å°½å¯èƒ½ç”¨ DOM æ“ä½œã€‚
            
            // ä¸ºäº†â€œæ— ç¼â€ï¼Œæˆ‘ä»¬å°è¯•æ“ä½œ DOMã€‚
            // éœ€åœ¨ index.html é‡Œç»™å…³é”®å…ƒç´ åŠ  IDã€‚
            // è¿™é‡Œæˆ‘ä»¬å‡è®¾å·²ç»æ·»åŠ äº† IDï¼ˆä¸‹ä¸ªæ­¥éª¤ä¼šå»æ·»åŠ ï¼‰ã€‚
            
            const btnMachine = document.getElementById('btn-machine-toggle');
            const machineStatusText = document.getElementById('machine-status-text'); // å‡è®¾æœ‰è¿™ä¸ª
            
            if (btnMachine) {
                if (p.on_machine) {
                    btnMachine.classList.remove('btn-outline-primary');
                    btnMachine.classList.add('btn-danger');
                    btnMachine.innerHTML = '<i class="bi bi-stop-circle me-1"></i> ä¸‹æœº';
                } else {
                    btnMachine.classList.remove('btn-danger');
                    btnMachine.classList.add('btn-outline-primary');
                    btnMachine.innerHTML = '<i class="bi bi-play-circle me-1"></i> ä¸Šæœº';
                }
            }
        }

        pollPlayerStatus();
    })();
</script>
<!-- Force Server Update: Fixed 500 Error v2 -->
